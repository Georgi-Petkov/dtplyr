<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Translation • dtplyr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../tidyverse-2.css" rel="stylesheet">
<meta property="og:title" content="Translation">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- google analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-115082821-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">dtplyr</a>
        <div class="info">
          <span class="partof">part of the <a href="https://tidyverse.org">tidyverse</a></span>
          <span class="version version-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.3.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/translation.html">Translation</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/tidyverse/dtplyr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Translation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/dtplyr/blob/master/vignettes/translation.Rmd"><code>vignettes/translation.Rmd</code></a></small>
      <div class="hidden name"><code>translation.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette shows the details of how dtplyr translates dplyr expressions into <a href="https://github.com/Rdatatable/data.table/wiki">data.table</a> code. If you see places where you think I could generate better data.table code, please let me know!</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dtplyr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(data.table)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)</a></code></pre></div>
</div>
<div id="the-basics" class="section level1">
<h1 class="hasAnchor">
<a href="#the-basics" class="anchor"></a>The basics</h1>
<p>To get started, I’ll create a simple lazy frame. The actual data doesn’t matter here since we’re just looking at the translation:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">df &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">a =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">integer</a></span>(), <span class="dt">b =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">integer</a></span>(), <span class="dt">c =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">integer</a></span>(), <span class="dt">d =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">integer</a></span>())</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">dt &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lazy_dt.html">lazy_dt</a></span>(df)</a></code></pre></div>
<p>When we print it out, it tells us that it’s a local data table with four rows. It also prints the call that dtplyr will evaluate when we execute the lazy table. In this case it’s very simple:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">dt</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; Source: local data table [?? x 4]</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#&gt; Call:   `_DT1`</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">#&gt; # … with 4 variables: a &lt;int&gt;, b &lt;int&gt;, c &lt;int&gt;, d &lt;int&gt;</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt; # Use as.data.table()/as.data.frame()/as_tibble() to access results</span></a></code></pre></div>
<p>If we just want to see the generated code, you can use <code><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query()</a></code>. I’ll use that a lot in this vignette.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#&gt; `_DT1`</span></a></code></pre></div>
</div>
<div id="simple-verbs" class="section level1">
<h1 class="hasAnchor">
<a href="#simple-verbs" class="anchor"></a>Simple verbs</h1>
<p>Many dplyr verbs have a straightforward translation to either the <code>i</code> or <code>j</code> component of <code>[.data.table</code>.</p>
<div id="i" class="section level2">
<h2 class="hasAnchor">
<a href="#i" class="anchor"></a><code>i</code>
</h2>
<p><code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code> become elements of <code>i</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(a, b, c) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">#&gt; `_DT1`[order(a, b, c), ]</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(b <span class="op">==</span><span class="st"> </span>c) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt; `_DT1`[b == c, ]</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(b <span class="op">==</span><span class="st"> </span>c, c <span class="op">==</span><span class="st"> </span>d) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co">#&gt; `_DT1`[b == c &amp; c == d, ]</span></a></code></pre></div>
</div>
<div id="j" class="section level2">
<h2 class="hasAnchor">
<a href="#j" class="anchor"></a><code>j</code>
</h2>
<p><code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/select.html">rename()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute()</a></code> all become elements of <code>j</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(a<span class="op">:</span>b) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt; `_DT1`[, .(a, b)]</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">x =</span> a, <span class="dt">y =</span> b) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#&gt; setnames(copy(`_DT1`), c("a", "b"), c("x", "y"))</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">a =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(a)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt; `_DT1`[, .(a = mean(a))]</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span>(<span class="dt">a2 =</span> a <span class="op">*</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#&gt; `_DT1`[, .(a2 = a * 2)]</span></a></code></pre></div>
<p><code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> also uses the <code>j</code> component with data.table’s special <code>:=</code> operator:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">a2 =</span> a <span class="op">*</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">b2 =</span> b <span class="op">*</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt; copy(`_DT1`)[, `:=`(a2 = a * 2, b2 = b * 2)]</span></a></code></pre></div>
<p>Note that dplyr doesn’t modifies the input data (unless you set <code>immutable = FALSE</code>), so here it automatically <code><a href="https://www.rdocumentation.org/packages/data.table/topics/copy">copy()</a></code>s the input data.table.</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> allows to refer to variables that you just created. data.tables <code>:=</code> doesn’t support that out of the box, so we automatically chain together as many <code>[</code> as needed:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">a2 =</span> a <span class="op">*</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">b2 =</span> b <span class="op">*</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">a4 =</span> a2 <span class="op">*</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co">#&gt; copy(`_DT1`)[, `:=`(a2 = a * 2, b2 = b * 2)][, `:=`(a4 = a2 * </span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co">#&gt;     2)]</span></a></code></pre></div>
<p><code><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute()</a></code> works similarly:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span>(<span class="dt">a2 =</span> a <span class="op">*</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">b2 =</span> b <span class="op">*</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">a4 =</span> a2 <span class="op">*</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co">#&gt; copy(`_DT1`)[, `:=`(a2 = a * 2, b2 = b * 2)][, .(a2, b2, a4 = a2 * </span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#&gt;     2)]</span></a></code></pre></div>
</div>
<div id="grouping" class="section level2">
<h2 class="hasAnchor">
<a href="#grouping" class="anchor"></a>Grouping</h2>
<p>Just like in dplyr, <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> doesn’t do anything by itself, but instead modifies the operation of downstream verbs. This generally just involves using the <code>by</code> argument:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(a) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">b =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(b)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co">#&gt; `_DT1`[, .(b = mean(b)), by = .(a)]</span></a></code></pre></div>
<p>The primary exception is grouped <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>, which requires the use of <code>.SD</code> ()</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(a) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(b <span class="op">&lt;</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(b)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co">#&gt; `_DT1`[, .SD[b &lt; mean(b), ], by = .(a)]</span></a></code></pre></div>
</div>
<div id="distinct" class="section level2">
<h2 class="hasAnchor">
<a href="#distinct" class="anchor"></a>Distinct</h2>
<p><code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code> is translated to some form of <code><a href="https://www.rdocumentation.org/packages/data.table/topics/duplicated">unique()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co">#&gt; unique(`_DT1`)</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(a, b) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co">#&gt; unique(`_DT1`[, .(a, b)])</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(a, b, <span class="dt">.keep_all =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co">#&gt; unique(`_DT1`, by = c("a", "b"))</span></a></code></pre></div>
<p><code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code> on a computed column uses an intermediate step:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(<span class="dt">c =</span> a <span class="op">+</span><span class="st"> </span>b) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="co">#&gt; unique(`_DT1`[, .(c = a + b)])</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(<span class="dt">c =</span> a <span class="op">+</span><span class="st"> </span>b, <span class="dt">.keep_all =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt; unique(copy(`_DT1`)[, `:=`(c = a + b)], by = "c")</span></a></code></pre></div>
</div>
</div>
<div id="combinations" class="section level1">
<h1 class="hasAnchor">
<a href="#combinations" class="anchor"></a>Combinations</h1>
<p>dtplyr tries to generate generate data.table code as close to what you’d write by hand as possible, as this tends to unlock data.tables tremendous speed. For example, if you <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> and then <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>, dtplyr generates a single <code>[</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(a <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>a) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="co">#&gt; `_DT1`[a == 1, .(b, c, d)]</span></a></code></pre></div>
<p>And similarly for filtering and summarising:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(a) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(b <span class="op">&lt;</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(b)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">c =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(c)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="co">#&gt; `_DT1`[, .SD[b &lt; mean(b), .(c = max(c))], by = .(a)]</span></a></code></pre></div>
<p>Note however, that <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>ing and then <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>ing must generate two separate calls to <code>[</code>, because data.table evaluates <code>i</code> before <code>j</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>a) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(a <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="co">#&gt; `_DT1`[, .(b, c, d)][a == 1, ]</span></a></code></pre></div>
<p>Note that <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> can’t be combined because <code>dt[a == 1, .(b2 := b * 2)]</code> modifies the selected rows in place.</p>
<p>However, dtplyr does strive to avoid needless copies, so it won’t explicitly copy if there’s already an implicit copy produced by <code>[</code>, <code><a href="https://www.rdocumentation.org/packages/utils/topics/head">head()</a></code> or similar:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(x <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">a2 =</span> a <span class="op">*</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">b2 =</span> b <span class="op">*</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="co">#&gt; `_DT1`[x == 1, ][, `:=`(a2 = a * 2, b2 = b * 2)]</span></a></code></pre></div>
<p>Over time, as I learn more about data.table, I hope to expand the set of these simplifications.</p>
</div>
<div id="joins" class="section level1">
<h1 class="hasAnchor">
<a href="#joins" class="anchor"></a>Joins</h1>
<p>dtplyr converts mutating joins to <code><a href="https://www.rdocumentation.org/packages/data.table/topics/merge">merge()</a></code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">dt2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lazy_dt.html">lazy_dt</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">a =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(dt2, <span class="dt">by =</span> <span class="st">"a"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="co">#&gt; merge(`_DT1`, `_DT2`, all.x = TRUE, all.y = FALSE, by = "a")</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">right_join</a></span>(dt2, <span class="dt">by =</span> <span class="st">"a"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="co">#&gt; merge(`_DT2`, `_DT1`, all.x = TRUE, all.y = FALSE, by = "a")</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">inner_join</a></span>(dt2, <span class="dt">by =</span> <span class="st">"a"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="co">#&gt; merge(`_DT1`, `_DT2`, all = FALSE, by = "a")</span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">full_join</a></span>(dt2, <span class="dt">by =</span> <span class="st">"a"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="co">#&gt; merge(`_DT1`, `_DT2`, all = TRUE, by = "a")</span></a></code></pre></div>
<p>I don’t currently convert left joins to the more idiomatic <code>dt[dt2]</code> because I haven’t yet figured out how to handle the <code>suffixes</code> argument. This is a shame because there’s a big advantage of the <code>dt[dt2]</code> form: you can combine it with a <code>j</code> argument for efficient summaries, e.g. <code>dt[dt2, sum(x * y)]</code>.</p>
<p>Anti-joins are easy to translate because data.table has a specific form for them:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">anti_join</a></span>(dt2, <span class="dt">by =</span> <span class="st">"a"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="co">#&gt; `_DT1`[!`_DT2`, on = .(a)]</span></a></code></pre></div>
<p>Semi joins are little more complex:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">semi_join</a></span>(dt2, <span class="dt">by =</span> <span class="st">"a"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="co">#&gt; `_DT1`[unique(`_DT1`[`_DT2`, which = TRUE, nomatch = 0L, on = .(a)])]</span></a></code></pre></div>
</div>
<div id="performance" class="section level1">
<h1 class="hasAnchor">
<a href="#performance" class="anchor"></a>Performance</h1>
<p>There are two components to the performance of dtplyr: how long it takes to generate the translation, and how well translation performs. Given my exploration so far, I’m reasonably confident that we’re generating high-quality data.table code, so most of the cost should be in the translation itself.</p>
<p>The following code briefly explores the performance of a few different translations. A signficant amount of work is done by the dplyr verbs, so we benchmark the whole process. Note that dtplyr run-time scales with the complexity of the pipeline, not the size of the data, so these timings should apply regardless of the size of the underlying data. (The only exception is use of <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> will also generate a single copy of the input data.)</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">bench<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/bench/topics/mark">mark</a></span>(</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">  <span class="dt">filter =</span> dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(a <span class="op">==</span><span class="st"> </span>b, c <span class="op">==</span><span class="st"> </span>d),</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">  <span class="dt">mutate =</span> dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">a =</span> a <span class="op">*</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">a4 =</span> a2 <span class="op">*</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">a8 =</span> a4 <span class="op">*</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>(),</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">  <span class="dt">summarise =</span> dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(a) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">b =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(b)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>(),</a>
<a class="sourceLine" id="cb21-5" data-line-number="5">  <span class="dt">check =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6">)[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>]</a>
<a class="sourceLine" id="cb21-7" data-line-number="7"><span class="co">#&gt; # A tibble: 3 x 6</span></a>
<a class="sourceLine" id="cb21-8" data-line-number="8"><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc `gc/sec`</span></a>
<a class="sourceLine" id="cb21-9" data-line-number="9"><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb21-10" data-line-number="10"><span class="co">#&gt; 1 filter        176µs    198µs     4891.      280B     17.9</span></a>
<a class="sourceLine" id="cb21-11" data-line-number="11"><span class="co">#&gt; 2 mutate        453µs    495µs     1978.      280B     15.0</span></a>
<a class="sourceLine" id="cb21-12" data-line-number="12"><span class="co">#&gt; 3 summarise     576µs    639µs     1503.      280B     15.0</span></a></code></pre></div>
<p>These translations all take less than a millisecond, which suggests that the performance overhead of dtplyr should be negligible.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#the-basics">The basics</a></li>
      <li>
<a href="#simple-verbs">Simple verbs</a><ul class="nav nav-pills nav-stacked">
<li><a href="#i"><code>i</code></a></li>
      <li><a href="#j"><code>j</code></a></li>
      <li><a href="#grouping">Grouping</a></li>
      <li><a href="#distinct">Distinct</a></li>
      </ul>
</li>
      <li><a href="#combinations">Combinations</a></li>
      <li><a href="#joins">Joins</a></li>
      <li><a href="#performance">Performance</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="tidyverse">
  <p>dtplyr is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="https://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>
    Developed by Lionel Henry, <a href="http://hadley.nz">Hadley Wickham</a>.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>
      </footer>
</div>

  

  </body>
</html>
